{% extends ../base.html %}

<<<<<<< HEAD
{% block title %}{{ _('Crafty Controller - File Management') }}{% end %}

{% block content %}

<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-md-6">      
        <h1 class="m-0">
    {{ _('File Management') }}
    <small style="font-size:.45em;">
       {{ _('Be careful here.') }}
    </small>
        </h1>
      </div>
      <div class="col-md-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="/admin/dashboard"><i class="fas fa-tachometer-alt"></i> {{ _('Home') }}</a></li>
          <li class="active breadcrumb-item">{{ _('File Management') }}</li>
        </ol>
      </div>
    </div>
  </div>
</div>
=======
{% block title %}Crafty Controller - File Management{% end %}

{% block content %}

<section class="content-header">
  <h1>
    File Management
    <small>
       Be careful here.
    </small>
  </h1>
  <ol class="breadcrumb">
    <li><a href="/admin/dashboard"><i class="fa fa-dashboard"></i> Home</a></li>
    <li class="active">File Management</li>
  </ol>
</section>
>>>>>>> snapshot


<section class="content">

    <div class="row">
<<<<<<< HEAD
        <div class="col-6">
            <div class="card card-secondary card-outline">
                <div class="card-header">
                  <h3 class="card-title">
                      {{ _('Current Directory:') }} {{ data['pwd'] }}
                  </h3>
                </div>
                <div class="card-body">
                    <form method="post" id="browser" action="files">
                        {% raw xsrf_form_html() %}
                        <input type="hidden" id="next_dir" name="next_dir" value="" />
                        <input type="hidden" id="server_id" name="server_id" value="{{ data['server_id'] }}" />

                        {% if data['parent'] %}
                        <a onclick="sub_form('{{ data['parent'] }}')">
                            <i class="fas fa-level-up" aria-hidden="true"></i>{{ data['parent'] }}
                        </a>
                        <br />
                        <br />
                        {% end %}
                            <div class="">
                            <table class="table table-striped table-bordered table-hover " id="files_table">
                            <thead>
                            <th>&nbsp;</th>
                            <th>{{ _('Size') }}</th>
                            <th>{{ _('File') }}</th>
                            <th>{{ _('Delete') }}</th>
                            </thead>
                            <tbody>
                                  {% for f in data['listing'] %}

                                  <tr>
                                      <td width="15px">
                                          {% if f['type'] == "file" %}
                                          <span class="text-success"><i class="fas fa-file" aria-hidden="true"></i></span>
                                          {% else %}
                                            <i class="text-primary fa fa-folder" aria-hidden="true"></i>
                                          {% end %}
                                      </td>

                                      <td width="30px">
                                          {% if f['type'] == "file" %}
                                              {{ f['size'] }}
                                          {% end %}
                                      </td>

                                      <td>
                                          {% if f['type'] == "file" %}
                                                {% if f['name'][-4:] in data['ext_list'] %}
                                                    <a onclick="edit_file('{{ f['name'] }}')">
                                                        <span class="text-success">{{ f['name'] }}</span>
                                                    </a>

                                                {% elif f['name'][-4:] == '.zip' %}
                                                    <a onclick="extract_file('{{ f['name'] }}')">
                                                        <span class="text-info">{{ f['name'] }}</span>
                                                    </a>
                                                {% else %}
                                                    <span class="text-danger">{{ f['name'] }}</span>
                                                {% end %}
                                          {% else %}
                                          <a onclick="sub_form('{{ f['name'] }}')">
                                            {{ f['name'] }}
                                          </a>
                                          {% end %}
                                      </td>

                                      <td width="30px">
                                          <a onclick="del_file('{{ f['name'] }}')" class="btn btn-sm btn-danger text-white">
                                              <i class="fas fa-trash" aria-hidden="true"></i> Delete
                                          </a>

                                      </td>
                                  </tr>
                                  {% end %}

                            </tbody>
                        </table>
                            </div>
                    </form>
                </div>
              </div>
        </div>


        <div class="col-6">

            <div class="card card-secondary card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-server" aria-hidden="true"></i> {{ _('Upload File to Dir:') }} {{ data['pwd'] }}</h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <div class="row">
                    <div class="col-6 ">
                        <a class="btn btn-info text-white" id="new_folder" onclick="new_file_folder('folder')">New Folder</a>
                        <a class="btn btn-info text-white" id="new_file" onclick="new_file_folder('file')">New File</a>
                    </div>

                    <div class="col-6 ">
                        <div class="form-group">
                            <form enctype="multipart/form-data" action="/admin/upload" method="post">
                                {% raw xsrf_form_html() %}
                                <input type="hidden" name="pwd" value="{{ data['pwd'] }}"/>
                                <input type="hidden" name="server_id" value="{{ data['server_id'] }}" />

                                <div class="form-group">
                                <label for="file1">Upload A File Here</label>
                                <input type="file" name="file1" class="form-control-file">
                                </div>
                                <input type="submit" value="Upload File" class="btn btn-success"/>
                                <p class="form-text">Upload a file to {{ data['pwd'] }}</p>
                                <!-- <label for="file1">Upload A File Here</label>
                                <input type="file" name="file1">
                                <input type="submit" value="Upload File" class="btn btn-success"/>
                                <p class="form-text">Upload a file to {{ data['pwd'] }}</p>-->
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>

    </div>
=======
        <div class="col-xs-6">
            <div class="box">
                <div class="box-header with-border">
                  <h3 class="box-title">
                      Current Directory: {{ data['pwd'] }}
                  </h3>
                </div>
                <div class="box-body">
                  <form method="post" id="browser">
                      {% raw xsrf_form_html() %}
                      <input type="hidden" id="next_dir" name="next_dir" value="" />
                      <input type="hidden" id="server_id" name="server_id" value="{{ data['server_id'] }}" />

                      {% if data['parent'] %}
                        <a onclick="sub_form('{{ data['parent'] }}')">
                            <i class="fa fa-level-up" aria-hidden="true"></i>{{ data['parent'] }}
                        </a>
                        <br />
                        <br />
                      {% end %}
                            <table class="table" id="files_table">
                                <thead>
                                <th>&nbsp;</th>
                                <th>Size</th>
                                <th>File</th>
                                </thead>
                                <tbody>
                                      {% for f in data['listing'] %}

                                      <tr>
                                          <td width="15px">
                                              {% if f['type'] == "file" %}
                                              <span class="text-success"><i class="fa fa-file" aria-hidden="true"></i></span>
                                              {% else %}
                                                <i class="text-primary fa fa-folder" aria-hidden="true"></i>
                                              {% end %}
                                          </td>
                                          <td width="30px">
                                              {% if f['type'] == "file" %}
                                                {{ f['size'] }}
                                              {% end %}
                                          </td>
                                          <td>
                                              {% if f['type'] == "file" %}
                                                  {% if f['name'][-4:] in data['ext_list'] %}
                                                    <a onclick="edit_file('{{ f['name'] }}')">
                                                        <span class="text-success">{{ f['name'] }}</span>
                                                    </a>
                                                    {% else %}
                                                        <span class="text-danger">{{ f['name'] }}</span>
                                                    {% end %}
                                              {% else %}
                                              <a onclick="sub_form('{{ f['name'] }}')">
                                                {{ f['name'] }}
                                              </a>
                                              {% end %}
                                          </td>
                                      </tr>
                                      {% end %}

                                </tbody>
                            </table>


                  </form>
                </div>

              </div>
        </div>
        <div class="col-xs-6">

            <div class="box box-solid">
            <div class="box-header with-border">
              <i class="fa fa-server" aria-hidden="true"></i>
                {% if not data['ftp_running'] %}
                    <h3 class="box-title">FTP Server Control: Server is currently
                        <span class="text-danger">Down <i class="fa fa-thumbs-down" aria-hidden="true"></i></span></h3>
                {% else %}
                    <h3 class="box-title">FTP Server Control: Server is currently
                        <span class="text-success">Up <i class="fa fa-thumbs-up" aria-hidden="true"></i></span><br />
                        Serving Dir: {{ data['ftp_root'] }}
                    </h3>
                {% end %}

            </div>
            <!-- /.box-header -->
            <div class="box-body">
                <div class="row">
                    <div class="col-xs-6 text-center">
                        <a href="/admin/commands?command=ftp_server_start&id={{ data['server_id'] }}"
                           onclick="delay()"
                            class="btn btn-app disabled=true {% if data['ftp_running'] %} disabled {% end %}">
                            <i class="fa fa-play"></i> Start FTP Server
                        </a>
                        <a  href="/admin/commands?command=ftp_server_stop&id={{ data['server_id'] }}"
                            onclick="delay()"
                            class="btn btn-app {% if not data['ftp_running'] %} disabled {% end %}">
                            <i class="fa fa-stop"></i> Stop FTP Server
                        </a>
                    </div>
                    <div class="col-xs-6">
                        <b>The credentials are:</b><br />
                        Username: {{ data['ftp_settings']['user'] }}<br />
                        Password: {{ data['ftp_settings']['password'] }}<br />
                        Port: {{ data['ftp_settings']['port'] }}<br />
                    </div>
                </div>

            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
    </div>


>>>>>>> snapshot
</section>

<!--
{{ data }}
-->




{% end %}

{% block js-script %}
<script>
    $('#files_table').DataTable({
            "order": [[ 1, "asc" ]],
<<<<<<< HEAD
            "pageLength": 25,
            "paging":true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
=======
            "pageLength": 25
>>>>>>> snapshot
        });

    //used to get cookies from browser - this is part of tornados xsrf protection - it's for extra security
    function getCookie(name) {
        var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
        return r ? r[1] : undefined;
    }

<<<<<<< HEAD
    function show_saved(){
        var dialog = bootbox.dialog({
            message: "{{ _('File Saved') }}",
            className: 'modal modal-success fade-in',
            okButton: false
        });
    }
=======
>>>>>>> snapshot

    function sub_form(dir){
        $('#next_dir').val(dir);
        document.getElementById('browser').submit();
    }

    function edit_file(file_path){
        $.ajax({
            type: 'GET',
            url: '/ajax/get_file',
            data: {
                'file_name': file_path,
                'server_id': {{ data['server_id'] }},
            },
            success: function (data) {
                console.log('Got file data from server')
                //console.log(data)

                var dialog = bootbox.dialog({
                    title: "<h3>Editing: " + file_path + "</h3>",
                    message: data,
                    size:"large",
                    closeButton: true
                });

             },
        });
    }

<<<<<<< HEAD
    function del_file(file_path){

        var token = getCookie("_xsrf")

        bootbox.confirm({
            title: "Delete File: "+file_path,
            message: "Are you sure you want to delete this? <b>There is no 'undo'</b><br />",
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-success'
                }
            },
            callback: function (result) {
                if (result){
                    $.ajax({
                        type: 'POST',
                        headers: {'X-XSRFToken': token},
                        url: '/ajax/del_server_file',
                        data: {
                            'file_name': file_path,
                            'server_id': {{ data['server_id'] }},
                        },
                        success: function (data) {
                            location.reload();
                         },
                    });
                }
            }
        });

    }

    function new_file_folder(type){
        var token = getCookie("_xsrf")

        bootbox.prompt({
            title: "What is the name of this new " + type + "?",
            callback: function(result){
                console.log(result);
                if (result){
                    $.ajax({
                        type: 'POST',
                        headers: {'X-XSRFToken': token},
                        url: '/ajax/new_file_folder',
                        data: {
                            'name': result,
                            'type': type,
                            'server_id': {{ data['server_id'] }},
                            'pwd': '{{ data['pwd'] }}',
                        },
                        success: function (data) {
                            location.reload();
                         },
                    });
                }
            }
        });

    }

    function extract_file(file_path){

        var token = getCookie("_xsrf")

        bootbox.confirm({
            title: "Unzip File: "+file_path,
            message: "Are you sure you want to unzip the file here?<br />",
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-success'
                }
            },
            callback: function (result) {
                $.ajax({
                    type: 'POST',
                    headers: {'X-XSRFToken': token},
                    url: '/ajax/unzip_server_file',
                    data: {
                        'file_name': file_path,
                        'server_id': {{ data['server_id'] }},
                        'pwd': '{{ data['pwd'] }}',
                    },
                    success: function (data) {
                        location.reload();
                     },
                });
            }
        });

    }



=======
>>>>>>> snapshot
    function delay(time='1-2'){
            bootbox.alert({
            message: "Please give the server " + time + " seconds to respond to your command",
            backdrop: true
        });
    }

<<<<<<< HEAD
    function hide_modal(){
        bootbox.hideAll()
    }

    $( document ).ready(function() {
        console.log( "ready!" );

        //adding quick/dirty padding
        $('input').css("margin-bottom",'10px')

        {% try %}
            {% if data['upload_success'] %}
                show_saved()
                setTimeout(hide_modal, 1000);
            {% end %}
        {% except %}
        {% end %}




    });

=======
>>>>>>> snapshot

</script>


{% end %}